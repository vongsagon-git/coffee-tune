<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TUNER">
  <meta name="theme-color" content="#006241">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>WANWAN COFFEE TUNER</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            // Premium Coffee Palette
            coffee: {
              900: '#1C1412',      // Rich espresso (darkest)
              800: '#2D241F',      // Dark roast
              700: '#3D322B',      // Medium-dark
              600: '#5C4A3D',      // Medium roast
              500: '#8B7355',      // Light roast
              400: '#B89B7A',      // Crema
              300: '#D4C4B0',      // Latte
              200: '#E8DFD3',      // Milk foam
              100: '#F5F1EC',      // Off-white
              50: '#FDFCFB',       // Pure cream
            },
            // Accent colors
            accent: {
              DEFAULT: '#B87333',  // Copper (premium feel)
              light: '#D4956A',    // Light copper
              dark: '#8B5A2B',     // Dark copper
              gold: '#C9A227',     // Gold accent
            },
            // Success/Warning states
            success: {
              DEFAULT: '#2D7D46',
              light: '#4CAF50',
              dark: '#1B5E20',
            },
            warning: {
              DEFAULT: '#E07B39',
              light: '#FF9800',
              dark: '#E65100',
            },
            // Dark mode palette
            dark: {
              50: '#f7f7f7',
              100: '#e3e3e3',
              200: '#c8c8c8',
              300: '#a4a4a4',
              400: '#818181',
              500: '#666666',
              600: '#515151',
              700: '#434343',
              800: '#2a2622',
              900: '#1a1714',
              950: '#0d0b0a',
            },
          }
        }
      }
    }
  </script>
  <style>
    [v-cloak] { display: none; }
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    input, textarea { -webkit-user-select: text; user-select: text; }
    body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      font-family: 'Inter', system-ui, sans-serif;
    }
    ::-webkit-scrollbar { display: none; }
    html { scrollbar-width: none; }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }

    /* ═══════════════════════════════════════════════════════════
       UNIVERSAL APP DESIGN v8.0
       Style: Clean, Solid, Minimal - Apple/Google Level
    ═══════════════════════════════════════════════════════════ */

    /* Smooth Animations */
    .page-slide { animation: pageSlide 0.3s ease-out; }
    @keyframes pageSlide {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Shake Animation for Validation Error */
    .shake { animation: shake 0.4s ease-out; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-4px); }
      80% { transform: translateX(4px); }
    }

    /* Pop Animation for Success */
    .pop { animation: pop 0.3s ease-out; }
    @keyframes pop {
      0% { transform: scale(0.95); opacity: 0; }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Pulse Animation for Highlights */
    .pulse { animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Respect user's motion preferences (accessibility) */
    @media (prefers-reduced-motion: reduce) {
      .page-slide, .shake, .pop, .pulse {
        animation: none;
      }
      .touch-feedback:active {
        transform: none;
      }
      * {
        transition-duration: 0.01ms !important;
      }
    }

    /* Clean Card */
    .card {
      background: #FFFFFF;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06);
    }

    /* Clean Input */
    .input-field {
      background: #F5F5F5;
      border: 2px solid transparent;
      border-radius: 12px;
      transition: all 0.2s ease;
      color: #1A1A1A;
      font-weight: 500;
    }
    .input-field:focus {
      background: #FFFFFF;
      border-color: #007AFF;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
    }
    .input-field::placeholder {
      color: #999999;
      font-weight: 400;
    }

    /* Solid Button */
    .btn-primary {
      background: #007AFF;
      border-radius: 12px;
      transition: all 0.2s ease;
      color: #FFFFFF;
      font-weight: 600;
    }
    .btn-primary:active {
      transform: scale(0.98);
      background: #0066DD;
    }
    .btn-primary:disabled {
      background: #E5E5E5;
      color: #999999;
    }

    /* Stat Box */
    .stat-box {
      background: #F5F5F5;
      border-radius: 12px;
    }

    /* Bottom Navigation - iOS Style */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0, 0, 0, 0.08);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 20px;
      transition: color 0.2s ease;
    }
    .nav-item.active { color: #007AFF; }
    .nav-item:not(.active) { color: #8E8E93; }
    .nav-icon { font-size: 24px; margin-bottom: 2px; }
    .nav-label { font-size: 10px; font-weight: 500; }

    /* Touch Feedback */
    .touch-feedback:active {
      transform: scale(0.97);
      opacity: 0.7;
    }

    /* Progress Bar */
    .progress-bar {
      background: #E5E5E5;
      border-radius: 4px;
      overflow: hidden;
      height: 6px;
    }
    .progress-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: #34C759;
      transition: width 0.4s ease;
    }

    /* Clean Header */
    .header-clean {
      background: #FFFFFF;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }

    /* Status Colors */
    .text-success { color: #34C759; }
    .text-warning { color: #FF9500; }
    .text-danger { color: #FF3B30; }
    .text-info { color: #007AFF; }
    .bg-success { background: #34C759; }
    .bg-warning { background: #FF9500; }
    .bg-success-light { background: rgba(52, 199, 89, 0.12); }
    .bg-warning-light { background: rgba(255, 149, 0, 0.12); }
    .bg-info-light { background: rgba(0, 122, 255, 0.12); }

    /* Divider */
    .divider {
      height: 1px;
      background: rgba(0, 0, 0, 0.08);
    }

    /* Badge */
    .badge {
      padding: 4px 10px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 600;
    }

    /* ═══════════════════════════════════════════════════════════
       DARK MODE
    ═══════════════════════════════════════════════════════════ */
    .dark body, .dark { background: #000000; color: #FFFFFF; }
    .dark .card {
      background: #1C1C1E;
      box-shadow: none;
    }
    .dark .input-field {
      background: #2C2C2E;
      color: #FFFFFF;
    }
    .dark .input-field:focus {
      background: #3A3A3C;
      border-color: #0A84FF;
    }
    .dark .input-field::placeholder { color: #636366; }
    .dark .stat-box { background: #2C2C2E; }
    .dark .bottom-nav {
      background: rgba(28, 28, 30, 0.9);
      border-top-color: rgba(255, 255, 255, 0.1);
    }
    .dark .nav-item.active { color: #0A84FF; }
    .dark .nav-item:not(.active) { color: #636366; }
    .dark .header-clean {
      background: #1C1C1E;
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }
    .dark .progress-bar { background: #3A3A3C; }
    .dark .divider { background: rgba(255, 255, 255, 0.1); }
    .dark .text-gray-500 { color: #8E8E93; }
    .dark .text-gray-600 { color: #AEAEB2; }
    .dark .bg-gray-100 { background: #2C2C2E; }
    .dark .bg-gray-50 { background: #1C1C1E; }

    /* Screen Reader Only (Accessibility) */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <div id="app" v-cloak role="application" aria-label="WANWAN Coffee Tuner Application">
    <!-- Onboarding Modal (First-time users) -->
    <div v-if="showOnboarding" class="fixed inset-0 bg-black/70 z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4" role="dialog" aria-modal="true" aria-label="คู่มือการใช้งาน">
      <div class="w-full sm:max-w-sm p-5 sm:p-6 shadow-xl max-h-[85vh] sm:max-h-[90vh] overflow-y-auto rounded-t-2xl sm:rounded-2xl" :class="darkMode ? 'bg-dark-800 text-dark-100' : 'bg-white text-gray-800'">
        <!-- Step 1: Welcome -->
        <div v-if="onboardingStep === 1" class="text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-accent/10 flex items-center justify-center">
            <svg class="w-8 h-8 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8zM6 1v3M10 1v3M14 1v3"/>
            </svg>
          </div>
          <h2 class="text-xl font-bold mb-2" :class="darkMode ? 'text-white' : 'text-gray-900'">Welcome to Coffee Tuner</h2>
          <p class="text-sm mb-4" :class="darkMode ? 'text-dark-300' : 'text-gray-500'">Professional espresso tuning tool</p>
          <div class="p-4 rounded-xl text-left space-y-3 text-sm" :class="darkMode ? 'bg-dark-700' : 'bg-gray-50'">
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-accent flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
              <div><b class="text-accent">Target:</b> <span :class="darkMode ? 'text-gray-300' : 'text-gray-600'">EY 18-22% and TDS 8-12%</span></div>
            </div>
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-accent flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
              <div><b class="text-accent">Standard:</b> <span :class="darkMode ? 'text-gray-300' : 'text-gray-600'">SCA (Specialty Coffee Association)</span></div>
            </div>
          </div>
        </div>
        <!-- Step 2: Grind -->
        <div v-if="onboardingStep === 2" class="text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-accent/10 flex items-center justify-center">
            <svg class="w-8 h-8 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
          </div>
          <h2 class="text-xl font-bold mb-2" :class="darkMode ? 'text-white' : 'text-gray-900'">Step 1: Adjust Grind</h2>
          <p class="text-sm mb-4" :class="darkMode ? 'text-dark-300' : 'text-gray-500'">Adjust grind size until EY is 18-22%</p>
          <div class="p-4 rounded-xl text-left space-y-2 text-sm" :class="darkMode ? 'bg-dark-700' : 'bg-gray-50'">
            <p :class="darkMode ? 'text-gray-300' : 'text-gray-600'">• <b>EY too low (&lt;18%)</b> → Grind finer</p>
            <p :class="darkMode ? 'text-gray-300' : 'text-gray-600'">• <b>EY too high (&gt;22%)</b> → Grind coarser</p>
            <p class="text-orange-500 font-medium pt-2 border-t" :class="darkMode ? 'border-dark-600' : 'border-gray-200'">Note: Purge 2-3g after each grind change</p>
          </div>
        </div>
        <!-- Step 3: Yield -->
        <div v-if="onboardingStep === 3" class="text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-accent/10 flex items-center justify-center">
            <svg class="w-8 h-8 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
            </svg>
          </div>
          <h2 class="text-xl font-bold mb-2" :class="darkMode ? 'text-white' : 'text-gray-900'">Step 2: Adjust Yield</h2>
          <p class="text-sm mb-4" :class="darkMode ? 'text-dark-300' : 'text-gray-500'">Once EY is good, adjust Yield for TDS 8-12%</p>
          <div class="p-4 rounded-xl text-left space-y-2 text-sm" :class="darkMode ? 'bg-dark-700' : 'bg-gray-50'">
            <p :class="darkMode ? 'text-gray-300' : 'text-gray-600'">• <b>TDS too high (&gt;12%)</b> → Increase Yield</p>
            <p :class="darkMode ? 'text-gray-300' : 'text-gray-600'">• <b>TDS too low (&lt;8%)</b> → Decrease Yield</p>
            <p class="text-accent font-medium pt-2 border-t" :class="darkMode ? 'border-dark-600' : 'border-gray-200'">Tip: Keep Dose fixed after first shot</p>
          </div>
        </div>
        <!-- Step 4: Input Fields -->
        <div v-if="onboardingStep === 4" class="text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-accent/10 flex items-center justify-center">
            <svg class="w-8 h-8 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
            </svg>
          </div>
          <h2 class="text-xl font-bold mb-2" :class="darkMode ? 'text-white' : 'text-gray-900'">Required Inputs (6 values)</h2>
          <div class="p-4 rounded-xl text-left space-y-2 text-sm" :class="darkMode ? 'bg-dark-700' : 'bg-gray-50'">
            <div class="grid grid-cols-2 gap-2">
              <p :class="darkMode ? 'text-gray-300' : 'text-gray-600'"><span class="text-accent font-bold">1.</span> Grind Size</p>
              <p :class="darkMode ? 'text-gray-300' : 'text-gray-600'"><span class="text-accent font-bold">2.</span> Dose (g)</p>
              <p :class="darkMode ? 'text-gray-300' : 'text-gray-600'"><span class="text-accent font-bold">3.</span> Yield (g)</p>
              <p :class="darkMode ? 'text-gray-300' : 'text-gray-600'"><span class="text-accent font-bold">4.</span> Time (s)</p>
              <p :class="darkMode ? 'text-gray-300' : 'text-gray-600'"><span class="text-accent font-bold">5.</span> TDS %</p>
              <p :class="darkMode ? 'text-gray-300' : 'text-gray-600'"><span class="text-accent font-bold">6.</span> Brix %</p>
            </div>
          </div>
        </div>
        <!-- Step 5: Ready -->
        <div v-if="onboardingStep === 5" class="text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-green-500/10 flex items-center justify-center">
            <svg class="w-8 h-8 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/>
            </svg>
          </div>
          <h2 class="text-xl font-bold mb-2" :class="darkMode ? 'text-white' : 'text-gray-900'">You're Ready!</h2>
          <p class="text-sm mb-4" :class="darkMode ? 'text-dark-300' : 'text-gray-500'">Start tuning your first shot</p>
          <div class="p-4 rounded-xl text-left space-y-2 text-sm" :class="darkMode ? 'bg-green-500/10' : 'bg-green-50'">
            <p class="flex items-center gap-2" :class="darkMode ? 'text-green-400' : 'text-green-700'">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
              Enter all 6 values
            </p>
            <p class="flex items-center gap-2" :class="darkMode ? 'text-green-400' : 'text-green-700'">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
              Tap "Analyze"
            </p>
            <p class="flex items-center gap-2" :class="darkMode ? 'text-green-400' : 'text-green-700'">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
              Follow recommendations
            </p>
            <p class="flex items-center gap-2" :class="darkMode ? 'text-green-400' : 'text-green-700'">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
              Repeat until Perfect Zone!
            </p>
          </div>
        </div>

        <div class="flex justify-between items-center mt-6">
          <button v-if="onboardingStep > 1" @click="onboardingStep--" class="text-sm font-medium" :class="darkMode ? 'text-dark-400 hover:text-white' : 'text-gray-400 hover:text-gray-700'">
            ← Back
          </button>
          <span v-else></span>

          <div class="flex items-center gap-1.5">
            <span v-for="s in 5" :key="s" class="w-2 h-2 rounded-full transition-colors" :class="s === onboardingStep ? 'bg-accent' : (darkMode ? 'bg-dark-600' : 'bg-gray-200')"></span>
          </div>

          <button v-if="onboardingStep < 5" @click="onboardingStep++" class="btn-primary px-4 py-2 text-sm">
            Next →
          </button>
          <button v-else @click="finishOnboarding" class="btn-primary px-4 py-2 text-sm">
            Get Started
          </button>
        </div>

        <button @click="skipOnboarding" class="w-full text-center text-xs mt-4" :class="darkMode ? 'text-dark-500 hover:text-dark-300' : 'text-gray-400 hover:text-gray-600'">
          Skip tutorial
        </button>
      </div>
    </div>

    <!-- Offline Indicator -->
    <div v-if="!isOnline" class="fixed top-0 left-0 right-0 bg-amber-500 text-white text-center text-xs py-1 z-[110] flex items-center justify-center gap-1">
      <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0 1 19 12.55M5 12.55a10.94 10.94 0 0 1 5.17-2.39M10.71 5.05A16 16 0 0 1 22.58 9M1.42 9a15.91 15.91 0 0 1 4.7-2.88M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01"/></svg>
      Offline - Data saved locally
    </div>

    <!-- PWA Install Prompt -->
    <div v-if="showInstallPrompt" class="fixed bottom-20 left-4 right-4 bg-accent text-white p-4 rounded-2xl shadow-lg z-[90] sm:left-auto sm:right-4 sm:w-80">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><path d="M12 18h.01"/></svg>
        </div>
        <div class="flex-1">
          <p class="font-semibold text-sm">Install App</p>
          <p class="text-xs text-white/70 mt-1">Add to home screen for faster access</p>
        </div>
      </div>
      <div class="flex gap-2 mt-3">
        <button @click="installPWA" class="flex-1 py-2.5 bg-white text-accent text-sm font-semibold rounded-xl">
          Install
        </button>
        <button @click="dismissInstallPrompt" class="px-4 py-2.5 text-white/60 text-sm hover:text-white">
          Not now
        </button>
      </div>
    </div>

    <!-- Header (Clean iOS Style) -->
    <header class="header-clean py-3 px-5 sticky z-50" :class="[!isOnline ? 'top-6' : 'top-0', darkMode ? 'bg-dark-900 border-white/10' : '']" role="banner">
      <div class="max-w-md mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-gray-900 flex items-center justify-center" :class="darkMode ? 'bg-white' : ''">
            <svg class="w-5 h-5" :class="darkMode ? 'text-gray-900' : 'text-white'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8zM6 1v3M10 1v3M14 1v3"/>
            </svg>
          </div>
          <div>
            <h1 class="text-base font-semibold" :class="darkMode ? 'text-white' : 'text-gray-900'">Coffee Tuner</h1>
            <p class="text-xs text-gray-500">Shot #{{ shotNumber }}</p>
          </div>
        </div>
        <button @click="showTutorial" class="w-9 h-9 rounded-full flex items-center justify-center transition-colors" :class="darkMode ? 'bg-white/10 hover:bg-white/20' : 'bg-gray-100 hover:bg-gray-200'" title="ดูคู่มือ" aria-label="เปิดคู่มือการใช้งาน">
          <svg class="w-5 h-5" :class="darkMode ? 'text-white' : 'text-gray-600'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3M12 17h.01"/>
          </svg>
        </button>
      </div>
    </header>

    <main class="max-w-md mx-auto px-5 py-4 pb-28">
      <!-- ==================== PAGE 1: INPUT ==================== -->
      <div v-if="page === 'input'" class="page-slide space-y-5">
        <!-- Tuning Progress - Clean Design -->
        <div class="card p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                :class="!fixedGrind ? 'bg-blue-500 text-white' : 'bg-green-500 text-white'">1</div>
              <span class="text-sm font-medium" :class="!fixedGrind ? 'text-gray-900' : 'text-green-600'">
                {{ !fixedGrind ? 'หาเบอร์บด' : 'เบอร์บด OK' }}
              </span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium" :class="fixedGrind && !tdsIsGood ? 'text-gray-900' : (tdsIsGood ? 'text-green-600' : 'text-gray-400')">
                {{ tdsIsGood ? 'TDS OK' : 'ปรับ TDS' }}
              </span>
              <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                :class="tdsIsGood ? 'bg-green-500 text-white' : (fixedGrind ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-500')">2</div>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-fill" :class="isPerfect || (tdsIsGood && fixedGrind) ? 'bg-green-500' : 'bg-blue-500'"
              :style="{ width: (tdsIsGood && fixedGrind) ? '100%' : (fixedGrind ? '50%' : '25%') }"></div>
          </div>
          <p class="text-xs text-gray-500 text-center mt-2">
            {{ shotNumber === 1 ? 'ใส่ค่าทั้ง 6 ช่อง แล้วกดวิเคราะห์' :
               (!fixedGrind ? 'กำลังหาเบอร์บดที่ใช่ (EY 18-22%)' : 'เบอร์บดโอเคแล้ว ปรับ Yield ให้ TDS 8-12%') }}
          </p>
        </div>

        <!-- Input Card -->
        <div class="card p-5 space-y-5">
          <!-- Bean Name (only on first shot) -->
          <div v-if="shotNumber === 1">
            <div class="flex items-center justify-between mb-2">
              <label class="text-xs font-medium text-gray-500 uppercase tracking-wider">เมล็ดกาแฟ</label>
              <span class="text-xs text-gray-400">ไม่บังคับ</span>
            </div>
            <input type="text" v-model="beanName" placeholder="Ethiopia Yirgacheffe, Brazil..."
              class="input-field w-full h-12 text-sm text-center outline-none px-4">
          </div>

          <!-- Show Bean Name (locked after first shot) -->
          <div v-else-if="beanName" class="text-center">
            <span class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700">
              {{ beanName }}
            </span>
          </div>

          <!-- Row 1: Grind + Dose -->
          <div v-if="shotNumber === 1" class="grid grid-cols-2 gap-3">
            <div>
              <label for="input-grind" class="text-xs font-medium text-gray-500 uppercase tracking-wider block mb-2">Grind</label>
              <input id="input-grind" type="number" v-model.number="shot.grind" step="0.1" min="1" max="12" placeholder="5.0"
                class="input-field w-full h-14 text-xl font-semibold text-center outline-none"
                :class="shot.grind && (shot.grind < 1 || shot.grind > 12) ? 'border-red-500' : ''"
                aria-describedby="grind-hint"
                @keydown.enter.prevent="document.getElementById('input-dose')?.focus()">
              <span id="grind-hint" class="sr-only">Enter grind size between 1 and 12</span>
            </div>
            <div>
              <label for="input-dose" class="text-xs font-medium text-gray-500 uppercase tracking-wider block mb-2">Dose (g)</label>
              <input id="input-dose" type="number" v-model.number="shot.dose" step="0.1" min="10" max="30" placeholder="18"
                class="input-field w-full h-14 text-xl font-semibold text-center outline-none"
                :class="shot.dose && (shot.dose < 10 || shot.dose > 30) ? 'border-red-500' : ''"
                aria-describedby="dose-hint"
                @keydown.enter.prevent="document.getElementById('input-yield')?.focus()">
              <span id="dose-hint" class="sr-only">Enter dose in grams between 10 and 30</span>
            </div>
          </div>

          <!-- CONFIRMATION MODE: Lock Grind + Dose + Yield -->
          <div v-else-if="confirmationMode" class="bg-green-50 rounded-xl p-4 border border-green-200">
            <div class="flex items-center justify-between mb-3">
              <p class="text-xs text-green-700 font-medium">Confirmation {{ confirmationCount }}/2</p>
              <p class="text-xs text-green-600">ยืนยันอีก {{ 2 - confirmationCount }} ครั้ง</p>
            </div>
            <div class="grid grid-cols-3 gap-3 text-center">
              <div>
                <p class="text-xs text-gray-500 uppercase mb-1">Grind</p>
                <p class="text-xl font-bold text-green-600">{{ shot.grind }}</p>
              </div>
              <div>
                <p class="text-xs text-gray-500 uppercase mb-1">Dose</p>
                <p class="text-xl font-bold text-green-600">{{ shot.dose }}g</p>
              </div>
              <div>
                <p class="text-xs text-gray-500 uppercase mb-1">Yield</p>
                <p class="text-xl font-bold text-green-600">{{ shot.yield }}g</p>
              </div>
            </div>
          </div>

          <!-- Shot 2+: Locked values display -->
          <div v-else class="bg-gray-50 rounded-xl p-4">
            <div class="grid grid-cols-3 gap-3 text-center">
              <div>
                <p class="text-xs text-gray-500 uppercase mb-1">Grind</p>
                <p class="text-xl font-bold" :class="fixedGrind ? 'text-green-600' : 'text-blue-600'">{{ shot.grind }}</p>
                <p class="text-[10px]" :class="fixedGrind ? 'text-green-500' : 'text-blue-500'">{{ fixedGrind ? 'Locked' : 'Adjusting' }}</p>
              </div>
              <div>
                <p class="text-xs text-gray-500 uppercase mb-1">Dose</p>
                <p class="text-xl font-bold text-gray-700">{{ shot.dose }}g</p>
                <p class="text-[10px] text-gray-400">Fixed</p>
              </div>
              <div>
                <p class="text-xs text-gray-500 uppercase mb-1">Ratio</p>
                <p class="text-xl font-bold text-gray-700" v-if="shot.dose">1:{{ targetYield ? (targetYield / shot.dose).toFixed(1) : '?' }}</p>
              </div>
            </div>
          </div>

          <!-- Row 2: Yield + Time -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="input-yield" class="text-xs font-medium text-gray-500 uppercase tracking-wider block mb-2">
                Yield (g) <span v-if="shotNumber > 1" class="text-green-500 normal-case">Locked</span>
              </label>
              <div v-if="shotNumber > 1" class="input-field w-full h-14 flex items-center justify-center bg-green-50 border-green-200" role="status" aria-label="Yield locked">
                <p class="text-xl font-semibold text-green-600">{{ shot.yield }}g</p>
              </div>
              <input v-else id="input-yield" type="number" v-model.number="shot.yield" step="0.1" min="15" max="80" placeholder="36"
                class="input-field w-full h-14 text-xl font-semibold text-center outline-none"
                :class="shot.yield && (shot.yield < 15 || shot.yield > 80) ? 'border-red-500' : ''"
                aria-describedby="yield-hint"
                @keydown.enter.prevent="document.getElementById('input-time')?.focus()">
              <span id="yield-hint" class="sr-only">Enter yield in grams between 15 and 80</span>
            </div>
            <div>
              <label for="input-time" class="text-xs font-medium text-gray-500 uppercase tracking-wider block mb-2">Time (s)</label>
              <input id="input-time" type="number" v-model.number="shot.time" min="15" max="60" placeholder="28"
                class="input-field w-full h-14 text-xl font-semibold text-center outline-none"
                :class="shot.time && (shot.time < 15 || shot.time > 60) ? 'border-red-500' : ''"
                aria-describedby="time-hint"
                @keydown.enter.prevent="document.getElementById('input-tds')?.focus()">
              <span id="time-hint" class="sr-only">Enter extraction time in seconds between 15 and 60</span>
            </div>
          </div>

          <!-- Divider -->
          <div class="divider my-4"></div>

          <!-- Row 3: TDS + Brix -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="input-tds" class="text-xs font-medium text-gray-500 uppercase tracking-wider block mb-2">TDS %</label>
              <input id="input-tds" type="number" v-model.number="shot.tds" step="0.1" min="1" max="20" placeholder="10"
                class="input-field w-full h-14 text-xl font-semibold text-center outline-none"
                :class="shot.tds && (shot.tds < 1 || shot.tds > 20) ? 'border-red-500' : ''"
                aria-describedby="tds-hint"
                @keydown.enter.prevent="document.getElementById('input-brix')?.focus()">
              <span id="tds-hint" class="sr-only">Enter TDS percentage between 1 and 20</span>
            </div>
            <div>
              <label for="input-brix" class="text-xs font-medium text-gray-500 uppercase tracking-wider block mb-2">Brix %</label>
              <input id="input-brix" type="number" v-model.number="shot.brix" step="0.1" min="1" max="25" placeholder="12"
                class="input-field w-full h-14 text-xl font-semibold text-center outline-none"
                :class="shot.brix && (shot.brix < 1 || shot.brix > 25) ? 'border-red-500' : ''"
                aria-describedby="brix-hint"
                @keydown.enter.prevent="canAnalyze && analyze()">
              <span id="brix-hint" class="sr-only">Enter Brix percentage between 1 and 25</span>
            </div>
          </div>

        </div>

        <!-- Validation Errors -->
        <div v-if="validationErrors.length > 0" class="card p-4 bg-red-50 border border-red-200 shake" :class="darkMode && 'bg-red-500/10 border-red-500/30'" role="alert" aria-live="polite">
          <p class="text-xs font-medium mb-2" :class="darkMode ? 'text-red-400' : 'text-red-600'">Invalid Values</p>
          <ul class="text-sm space-y-1" :class="darkMode ? 'text-red-300' : 'text-red-500'" aria-label="Validation errors list">
            <li v-for="err in validationErrors" :key="err">{{ err }}</li>
          </ul>
        </div>

        <!-- Quick Stats (show after first shot) -->
        <div v-if="history.length > 0" class="card p-4">
          <p class="text-xs text-gray-500 font-medium uppercase tracking-wider mb-3">Session Stats</p>
          <div class="grid grid-cols-3 gap-3 text-center">
            <div class="bg-gray-50 rounded-lg p-3">
              <p class="text-lg font-bold text-green-600">{{ history.filter(h => h.ey >= 18 && h.ey <= 22).length }}</p>
              <p class="text-xs text-gray-500">EY OK</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <p class="text-lg font-bold text-green-600">{{ history.filter(h => h.tds >= 8 && h.tds <= 12).length }}</p>
              <p class="text-xs text-gray-500">TDS OK</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <p class="text-lg font-bold" :class="history.some(h => h.isPerfect) ? 'text-green-600' : 'text-gray-400'">{{ history.filter(h => h.isPerfect).length }}</p>
              <p class="text-xs text-gray-500">Perfect</p>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <button @click="analyze" :disabled="!canAnalyze || isAnalyzing"
          class="btn-primary w-full h-14 font-semibold text-base flex items-center justify-center gap-2"
          aria-label="วิเคราะห์ผลการชง"
          :aria-busy="isAnalyzing">
          <svg v-if="isAnalyzing" class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>{{ isAnalyzing ? 'กำลังวิเคราะห์...' : 'วิเคราะห์ผล' }}</span>
        </button>
      </div>

      <!-- ==================== PAGE 2: RESULT ==================== -->
      <div v-if="page === 'result'" class="page-slide space-y-4" role="region" aria-label="Analysis Results">

        <!-- Tuning Progress Card -->
        <div class="card p-4" role="status" aria-live="polite">
          <p class="text-xs text-gray-500 text-center mb-3 font-medium uppercase tracking-wider">Tuning Progress</p>
          <div class="flex items-center justify-between text-xs font-medium mb-2">
            <div class="flex items-center gap-2">
              <div class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold"
                :class="eyIsGood ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'">
                <svg v-if="eyIsGood" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>
                <span v-else>1</span>
              </div>
              <span :class="eyIsGood ? 'text-green-600' : 'text-gray-700'">EY {{ ey }}%</span>
            </div>
            <div class="flex items-center gap-2">
              <span :class="tdsIsGood ? 'text-green-600' : 'text-gray-500'">TDS {{ shot.tds }}%</span>
              <div class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold"
                :class="tdsIsGood ? 'bg-green-500 text-white' : (eyIsGood ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-500')">
                <svg v-if="tdsIsGood" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>
                <span v-else>2</span>
              </div>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-fill" :class="isPerfect ? 'bg-green-500' : 'bg-blue-500'"
              :style="{ width: isPerfect ? '100%' : (eyIsGood ? '50%' : '25%') }"></div>
          </div>
          <p class="text-xs text-gray-500 text-center mt-2">
            {{ isPerfect ? 'Perfect Zone!' : (eyIsGood ? 'Step 2: Adjust TDS to 8-12%' : 'Step 1: Adjust EY to 18-22%') }}
          </p>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-4 gap-2">
          <div class="stat-box p-3 text-center">
            <p class="text-[10px] text-gray-500 font-medium uppercase">Ratio</p>
            <p class="text-lg font-bold text-gray-800 mt-1">1:{{ ratio }}</p>
          </div>
          <div class="stat-box p-3 text-center" :class="eyIsGood ? 'bg-green-50' : 'bg-orange-50'">
            <p class="text-[10px] font-medium uppercase" :class="eyIsGood ? 'text-green-600' : 'text-orange-600'">EY%</p>
            <p class="text-lg font-bold mt-1" :class="eyIsGood ? 'text-green-600' : 'text-orange-600'">{{ ey }}</p>
          </div>
          <div class="stat-box p-3 text-center">
            <p class="text-[10px] text-gray-500 font-medium uppercase">Time</p>
            <p class="text-lg font-bold text-gray-800 mt-1">{{ shot.time }}s</p>
          </div>
          <div class="stat-box p-3 text-center" :class="tdsIsGood ? 'bg-green-50' : ''">
            <p class="text-[10px] font-medium uppercase" :class="tdsIsGood ? 'text-green-600' : 'text-gray-500'">TDS</p>
            <p class="text-lg font-bold mt-1" :class="tdsIsGood ? 'text-green-600' : 'text-gray-800'">{{ shot.tds }}%</p>
          </div>
        </div>

        <!-- Action Card (Not Perfect) -->
        <div v-if="!isPerfect" class="card p-5">
          <div class="text-center mb-4">
            <p class="text-3xl font-bold mb-1" :class="action.step === 1 ? 'text-orange-500' : 'text-blue-500'">
              {{ action.do }}
            </p>
            <p class="text-sm text-gray-500">{{ action.reason }}</p>
          </div>

          <div class="bg-gray-50 rounded-xl p-4 space-y-3">
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500 uppercase">Keep Same</span>
              <div class="flex gap-2">
                <span class="px-2 py-1 rounded-lg bg-white text-gray-700 text-xs font-medium">Dose {{ shot.dose }}g</span>
                <span v-if="action.step === 2" class="px-2 py-1 rounded-lg bg-white text-gray-700 text-xs font-medium">Grind {{ shot.grind }}</span>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500 uppercase">Adjust</span>
              <span class="px-3 py-1.5 rounded-lg text-sm font-bold"
                :class="action.step === 1 ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'">
                {{ action.do }}
              </span>
            </div>
          </div>

          <p class="text-xs text-gray-400 text-center mt-3">{{ action.hint }}</p>
        </div>

        <!-- Perfect Result -->
        <div v-else class="card p-6 bg-green-50 border border-green-200">
          <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-500 flex items-center justify-center">
              <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M20 6L9 17l-5-5"/>
              </svg>
            </div>
            <p class="text-2xl font-bold text-green-700 mb-1">Perfect!</p>
            <p v-if="beanName" class="text-sm text-green-600 mb-4">{{ beanName }}</p>

            <div class="bg-white rounded-xl p-4 mt-4 text-left">
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div><span class="text-gray-500">Grind</span> <span class="font-semibold float-right">{{ shot.grind }}</span></div>
                <div><span class="text-gray-500">Dose</span> <span class="font-semibold float-right">{{ shot.dose }}g</span></div>
                <div><span class="text-gray-500">Yield</span> <span class="font-semibold float-right">{{ shot.yield }}g</span></div>
                <div><span class="text-gray-500">Time</span> <span class="font-semibold float-right">{{ shot.time }}s</span></div>
              </div>
              <div class="divider my-3"></div>
              <div class="text-center">
                <span class="text-green-600 font-semibold">EY {{ ey }}%</span>
                <span class="text-gray-400 mx-2">·</span>
                <span class="text-green-600 font-semibold">TDS {{ shot.tds }}%</span>
              </div>
            </div>

            <div class="flex gap-2 mt-5 justify-center">
              <button @click="saveRecipe" class="px-4 py-2.5 bg-green-600 hover:bg-green-700 rounded-xl text-sm font-medium text-white transition-all">
                {{ recipeSaved ? 'Saved!' : 'Save Recipe' }}
              </button>
              <button @click="copyRecipe" class="px-4 py-2.5 bg-white hover:bg-gray-50 rounded-xl text-sm font-medium text-gray-700 border border-gray-200 transition-all">
                {{ copied ? 'Copied!' : 'Copy' }}
              </button>
              <button v-if="canShare" @click="shareRecipe" class="px-4 py-2.5 bg-blue-500 hover:bg-blue-600 rounded-xl text-sm font-medium text-white transition-all">
                Share
              </button>
            </div>
          </div>
        </div>

        <!-- Next Button -->
        <button @click="nextShot" class="btn-primary w-full h-14 font-semibold text-base">
          {{ isPerfect ? 'Start New Session' : 'Next Shot' }}
        </button>

        <!-- Reset Button -->
        <button v-if="!isPerfect && shotNumber > 2" @click="resetSession"
          class="w-full text-center text-sm text-gray-400 hover:text-red-500 py-2">
          Reset Session
        </button>

        <!-- History Toggle -->
        <button v-if="history.length > 0" @click="showHistory = !showHistory"
          class="w-full text-center text-sm text-gray-400 hover:text-gray-600 py-2">
          {{ showHistory ? 'Hide History' : 'History (' + history.length + ')' }}
        </button>

        <!-- History List -->
        <div v-if="showHistory && history.length > 0" class="card p-4 space-y-2">
          <div v-for="(h, i) in reversedHistory" :key="h.id"
            class="p-3 bg-gray-50 rounded-xl flex items-center gap-3">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
              :class="h.isPerfect ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-600'">
              {{ history.length - i }}
            </div>
            <div class="flex-1">
              <p class="font-medium text-sm text-gray-800">Grind {{ h.grind }} · {{ h.time }}s</p>
              <p class="text-xs text-gray-500">EY {{ h.ey }}% · TDS {{ h.tds }}%</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== PAGE 3: RECIPES ==================== -->
      <div v-if="page === 'recipes'" class="page-slide space-y-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold flex items-center gap-2">
            <svg class="w-6 h-6 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20M4 19.5A2.5 2.5 0 0 0 6.5 22H20V2H6.5A2.5 2.5 0 0 0 4 4.5v15z"/>
              <path d="M8 7h8M8 11h8M8 15h5"/>
            </svg>
            Recipe Library
          </h2>
          <button @click="page = 'input'" class="text-sm text-gray-500 hover:text-accent">← กลับ</button>
        </div>

        <div v-if="recipes.length === 0" class="card p-8 text-center">
          <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/>
            <path d="M12 8v8M8 12h8" stroke-linecap="round"/>
          </svg>
          <p class="text-gray-600 font-medium">ยังไม่มีสูตรที่บันทึกไว้</p>
          <p class="text-xs text-gray-400 mt-2">จูนจนถึง Perfect Zone แล้วกด "บันทึกสูตร"</p>
        </div>

        <div v-else class="space-y-3">
          <div v-for="(r, i) in recipes" :key="r.id" class="card p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <p class="font-semibold text-gray-900" :class="darkMode && 'text-white'">{{ r.bean || 'No Name' }}</p>
                <div class="flex flex-wrap gap-3 mt-2 text-xs text-gray-500">
                  <span>Grind <b class="text-gray-700" :class="darkMode && 'text-gray-300'">{{ r.grind }}</b></span>
                  <span>Dose <b class="text-gray-700" :class="darkMode && 'text-gray-300'">{{ r.dose }}g</b></span>
                  <span>Yield <b class="text-gray-700" :class="darkMode && 'text-gray-300'">{{ r.yield }}g</b></span>
                  <span>Time <b class="text-gray-700" :class="darkMode && 'text-gray-300'">{{ r.time }}s</b></span>
                </div>
                <p class="text-xs text-green-600 mt-2 font-medium">EY {{ r.ey }}% · TDS {{ r.tds }}%</p>
                <p class="text-[10px] text-gray-400 mt-1">{{ new Date(r.savedAt).toLocaleDateString('th-TH') }}</p>
              </div>
              <div class="flex gap-2">
                <button @click="loadRecipe(r)" class="px-3 py-1.5 rounded-lg text-xs bg-accent text-white hover:bg-accent/90 font-medium">
                  ใช้สูตรนี้
                </button>
                <button @click="deleteRecipe(i)" class="p-1.5 rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14z"/>
                    <path d="M10 11v6M14 11v6"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== PAGE 4: SETTINGS ==================== -->
      <div v-if="page === 'settings'" class="page-slide space-y-5">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <svg class="w-6 h-6 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          Settings
        </h2>

        <!-- Shot Statistics -->
        <div v-if="history.length > 0" class="card p-4">
          <p class="text-xs text-gray-500 font-medium uppercase tracking-wider mb-3">STATISTICS</p>
          <div class="grid grid-cols-2 gap-3">
            <div class="text-center p-3 rounded-lg" :class="darkMode ? 'bg-dark-700' : 'bg-gray-50'">
              <p class="text-2xl font-bold text-accent">{{ stats.totalShots }}</p>
              <p class="text-[10px] text-gray-500 uppercase">Total Shots</p>
            </div>
            <div class="text-center p-3 rounded-lg" :class="darkMode ? 'bg-dark-700' : 'bg-gray-50'">
              <p class="text-2xl font-bold text-green-500">{{ stats.perfectShots }}</p>
              <p class="text-[10px] text-gray-500 uppercase">Perfect Zone</p>
            </div>
            <div class="text-center p-3 rounded-lg" :class="darkMode ? 'bg-dark-700' : 'bg-gray-50'">
              <p class="text-2xl font-bold" :class="darkMode ? 'text-gray-300' : 'text-gray-700'">{{ stats.avgEY }}%</p>
              <p class="text-[10px] text-gray-500 uppercase">Avg EY%</p>
            </div>
            <div class="text-center p-3 rounded-lg" :class="darkMode ? 'bg-dark-700' : 'bg-gray-50'">
              <p class="text-2xl font-bold" :class="darkMode ? 'text-gray-300' : 'text-gray-700'">{{ stats.avgTDS }}%</p>
              <p class="text-[10px] text-gray-500 uppercase">Avg TDS%</p>
            </div>
          </div>
          <!-- Best Shot -->
          <div v-if="stats.bestShot" class="mt-4 p-3 rounded-lg" :class="darkMode ? 'bg-accent/20' : 'bg-green-50'">
            <p class="text-xs text-accent font-medium mb-2 flex items-center gap-1">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
              Best Shot
            </p>
            <div class="flex justify-between text-sm">
              <span :class="darkMode ? 'text-gray-400' : 'text-gray-600'">Grind {{ stats.bestShot.grind }} · {{ stats.bestShot.dose }}g → {{ stats.bestShot.yield }}g</span>
              <span class="text-green-500 font-medium">EY {{ stats.bestShot.ey }}%</span>
            </div>
          </div>
        </div>

        <!-- Equipment Info -->
        <div class="card p-4">
          <p class="text-xs text-gray-500 font-medium uppercase tracking-wider mb-3">EQUIPMENT</p>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span :class="darkMode ? 'text-gray-400' : 'text-gray-600'">Machine</span>
              <span :class="darkMode ? 'text-gray-200' : 'text-gray-800'" class="font-medium">Appia Life XT 2GR</span>
            </div>
            <div class="flex justify-between">
              <span :class="darkMode ? 'text-gray-400' : 'text-gray-600'">Grinder</span>
              <span :class="darkMode ? 'text-gray-200' : 'text-gray-800'" class="font-medium">F64 Evo Pro (1-12)</span>
            </div>
            <div class="flex justify-between">
              <span :class="darkMode ? 'text-gray-400' : 'text-gray-600'">Pressure</span>
              <span :class="darkMode ? 'text-gray-200' : 'text-gray-800'" class="font-medium">12 bar (Fixed)</span>
            </div>
          </div>
        </div>

        <!-- Data Management -->
        <div class="card p-4">
          <p class="text-xs text-gray-500 font-medium uppercase tracking-wider mb-3">DATA</p>
          <div class="space-y-3">
            <button @click="exportData" class="w-full py-3 rounded-lg text-sm font-medium touch-feedback flex items-center justify-center gap-2"
              :class="darkMode ? 'bg-dark-700 text-gray-300 hover:bg-dark-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
              Export Data
            </button>
            <button @click="importData" class="w-full py-3 rounded-lg text-sm font-medium touch-feedback flex items-center justify-center gap-2"
              :class="darkMode ? 'bg-dark-700 text-gray-300 hover:bg-dark-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
              Import Data
            </button>
            <button @click="clearAllData" class="w-full py-3 rounded-lg text-sm font-medium touch-feedback flex items-center justify-center gap-2 bg-red-50 text-red-500 hover:bg-red-100"
              :class="darkMode && 'bg-red-500/10 hover:bg-red-500/20'">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14z"/></svg>
              Clear All Data
            </button>
          </div>
        </div>

        <!-- Appearance -->
        <div class="card p-4">
          <p class="text-xs text-gray-500 font-medium uppercase tracking-wider mb-3">APPEARANCE</p>
          <button @click="toggleDarkMode" class="w-full py-3 rounded-lg text-sm font-medium touch-feedback flex items-center justify-center gap-2"
            :class="darkMode ? 'bg-dark-700 text-white hover:bg-dark-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'">
            <svg v-if="darkMode" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
            <svg v-else class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            {{ darkMode ? 'Light Mode' : 'Dark Mode' }}
          </button>
        </div>

        <!-- Help & Tutorial -->
        <div class="card p-4">
          <p class="text-xs text-gray-500 font-medium uppercase tracking-wider mb-3">HELP</p>
          <div class="space-y-3">
            <button @click="showTutorial" class="w-full py-3 rounded-lg text-sm font-medium touch-feedback flex items-center justify-center gap-2 bg-accent/10 text-accent hover:bg-accent/20">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3M12 17h.01"/></svg>
              View Tutorial
            </button>
            <button @click="resetOnboarding" class="w-full py-3 rounded-lg text-sm font-medium touch-feedback flex items-center justify-center gap-2"
              :class="darkMode ? 'bg-dark-700 text-gray-400 hover:bg-dark-600' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
              Reset Tutorial
            </button>
          </div>
        </div>

        <!-- App Installation -->
        <div v-if="deferredPrompt || canInstallPWA" class="card p-4">
          <p class="text-xs text-gray-500 font-medium uppercase tracking-wider mb-3">INSTALL</p>
          <button @click="installPWA" class="w-full py-3 rounded-lg bg-accent text-white text-sm font-medium hover:bg-accent/90 touch-feedback flex items-center justify-center gap-2">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><path d="M12 18h.01"/></svg>
            Add to Home Screen
          </button>
          <p class="text-xs text-gray-400 mt-2 text-center">Works faster, even offline</p>
        </div>

        <!-- About -->
        <div class="card p-4 text-center">
          <p class="text-lg font-bold text-accent">WANWAN COFFEE TUNER</p>
          <p class="text-xs text-gray-500 mt-1">v8.0 · Universal App Design</p>
          <p class="text-xs text-gray-400 mt-2">SCA Standards: EY 18-22% · TDS 8-12%</p>
        </div>
      </div>
    </main>

    <!-- Bottom Navigation (Clean iOS Style) -->
    <nav class="bottom-nav" role="navigation" aria-label="เมนูหลัก">
      <div class="max-w-md mx-auto flex justify-around py-2">
        <button @click="navigateTo('input'); showHistory = false" class="nav-item touch-feedback" :class="{ active: page === 'input' }" aria-label="หน้าจูนกาแฟ">
          <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8zM6 1v3M10 1v3M14 1v3"/>
          </svg>
          <span class="nav-label">Tune</span>
        </button>
        <button @click="navigateTo('recipes')" class="nav-item touch-feedback relative" :class="{ active: page === 'recipes' }" aria-label="คลังสูตรกาแฟ">
          <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20M4 19.5A2.5 2.5 0 0 0 6.5 22H20V2H6.5A2.5 2.5 0 0 0 4 4.5v15z"/>
          </svg>
          <span class="nav-label">Recipes</span>
          <span v-if="recipes.length" class="absolute top-0 right-4 w-4 h-4 bg-red-500 rounded-full text-[10px] text-white font-bold flex items-center justify-center">{{ recipes.length }}</span>
        </button>
        <button @click="navigateTo('settings')" class="nav-item touch-feedback" :class="{ active: page === 'settings' }" aria-label="หน้าตั้งค่า">
          <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          <span class="nav-label">Settings</span>
        </button>
      </div>
    </nav>
  </div>

  <script>
    const { createApp, ref, computed, onMounted } = Vue

    createApp({
      setup() {
        const page = ref('input')
        const shotNumber = ref(1)
        const showHistory = ref(false)
        const copied = ref(false)
        const recipeSaved = ref(false)
        const isAnalyzing = ref(false)  // Loading state for Analyze button
        const recipes = ref([])  // Recipe Library

        // Onboarding state
        const showOnboarding = ref(false)
        const onboardingStep = ref(1)

        // Dark Mode state
        const darkMode = ref(false)

        // PWA & Offline state
        const isOnline = ref(navigator.onLine)
        const deferredPrompt = ref(null)
        const showInstallPrompt = ref(false)

        // Bean name (set on first shot)
        const beanName = ref('')

        // Flavor options for selection
        const flavorOptions = [
          { id: 'sweet', icon: '🍯', name: 'หวาน' },
          { id: 'sour', icon: '🍋', name: 'เปรี้ยว' },
          { id: 'bitter', icon: '☕', name: 'ขม' },
          { id: 'fruity', icon: '🍒', name: 'ผลไม้' },
          { id: 'nutty', icon: '🥜', name: 'ถั่ว' },
          { id: 'chocolate', icon: '🍫', name: 'ช็อกโกแลต' },
          { id: 'floral', icon: '🌸', name: 'ดอกไม้' },
          { id: 'spicy', icon: '🌶️', name: 'เครื่องเทศ' }
        ]
        const fixedDose = ref(false)   // Lock Dose after Shot 1
        const targetYield = ref(null)  // Target Yield (can vary slightly)
        const fixedGrind = ref(false)  // Lock Grind when EY is good

        // Confirmation mode: verify Perfect with 2 more shots
        const confirmationMode = ref(false)
        const confirmationCount = ref(0)  // Need 2 confirmations
        const confirmedRecipe = ref(null) // Store recipe being confirmed

        const shot = ref({
          grind: null, dose: null, yield: null,
          time: null, tds: null, brix: null, notes: '', rating: 0, flavors: []
        })

        const history = ref([])           // Current session history
        const allTimeHistory = ref([])    // All-time history for stats (never cleared)

        // Input validation rules
        const validRanges = {
          grind: { min: 1, max: 12, label: 'เบอร์บด' },
          dose: { min: 10, max: 30, label: 'Dose' },
          yield: { min: 15, max: 80, label: 'Yield' },
          time: { min: 15, max: 60, label: 'Time' },
          tds: { min: 1, max: 20, label: 'TDS' },
          brix: { min: 1, max: 25, label: 'Brix' }
        }

        const validateField = (field, value) => {
          if (value === null || value === undefined || value === '') return false
          const range = validRanges[field]
          return value >= range.min && value <= range.max
        }

        const validationErrors = computed(() => {
          const errors = []
          for (const [field, range] of Object.entries(validRanges)) {
            const val = shot.value[field]
            if (val !== null && val !== undefined && val !== '') {
              if (val < range.min) errors.push(`${range.label} ต่ำเกินไป (min: ${range.min})`)
              else if (val > range.max) errors.push(`${range.label} สูงเกินไป (max: ${range.max})`)
            }
          }
          return errors
        })

        const canAnalyze = computed(() => {
          const hasAllValues = shot.value.grind && shot.value.dose && shot.value.yield &&
            shot.value.time && shot.value.tds && shot.value.brix
          const noErrors = validationErrors.value.length === 0
          return hasAllValues && noErrors
        })

        const ratio = computed(() => {
          if (!shot.value.dose || !shot.value.yield) return '-'
          return (shot.value.yield / shot.value.dose).toFixed(1)
        })

        const ey = computed(() => {
          if (!shot.value.dose || !shot.value.yield || !shot.value.tds) return null
          return ((shot.value.yield * shot.value.tds) / shot.value.dose).toFixed(1)
        })

        const eyVal = computed(() => ey.value ? parseFloat(ey.value) : null)

        const isPerfect = computed(() => {
          if (!eyVal.value) return false
          return eyVal.value >= 18 && eyVal.value <= 22 && shot.value.tds >= 8 && shot.value.tds <= 12
        })

        const direction = computed(() => eyVal.value < 18 ? 'under' : 'over')

        const chartX = computed(() => {
          if (!eyVal.value) return 100
          const ey = Math.max(14, Math.min(26, eyVal.value))
          return 10 + ((ey - 14) / 12) * 180
        })

        const chartY = computed(() => {
          if (!shot.value.tds) return 60
          const tds = Math.max(6, Math.min(14, shot.value.tds))
          return 100 - ((tds - 6) / 8) * 80
        })

        // Shot Statistics for Settings page (uses allTimeHistory)
        const stats = computed(() => {
          if (allTimeHistory.value.length === 0) {
            return { totalShots: 0, perfectShots: 0, avgEY: '-', avgTDS: '-', bestShot: null }
          }

          const total = allTimeHistory.value.length
          const perfect = allTimeHistory.value.filter(s => s.ey >= 18 && s.ey <= 22 && s.tds >= 8 && s.tds <= 12).length
          const avgEY = (allTimeHistory.value.reduce((sum, s) => sum + parseFloat(s.ey), 0) / total).toFixed(1)
          const avgTDS = (allTimeHistory.value.reduce((sum, s) => sum + parseFloat(s.tds), 0) / total).toFixed(1)

          // Find best shot (closest to EY 20%)
          const best = allTimeHistory.value.reduce((best, s) => {
            const diff = Math.abs(parseFloat(s.ey) - 20)
            const bestDiff = best ? Math.abs(parseFloat(best.ey) - 20) : 999
            return diff < bestDiff ? s : best
          }, null)

          return { totalShots: total, perfectShots: perfect, avgEY, avgTDS, bestShot: best }
        })

        const expectedFlavors = computed(() => {
          const flavors = []
          const eyv = eyVal.value
          const tds = shot.value.tds

          if (eyv < 18) {
            flavors.push({ name: 'Sour', type: 'bad' })
            flavors.push({ name: 'Thin', type: 'bad' })
          } else if (eyv > 22) {
            flavors.push({ name: 'Bitter', type: 'bad' })
            flavors.push({ name: 'Astringent', type: 'bad' })
          } else {
            flavors.push({ name: 'Sweet', type: 'good' })
            flavors.push({ name: 'Balanced', type: 'good' })
          }

          if (tds > 12) {
            flavors.push({ name: 'Very Strong', type: 'warn' })
          } else if (tds < 8) {
            flavors.push({ name: 'Weak', type: 'warn' })
          } else {
            flavors.push({ name: 'Good Body', type: 'good' })
          }

          return flavors
        })

        // Flavor Profile based on extraction science
        const flavorProfile = computed(() => {
          const eyv = eyVal.value || 0
          const time = shot.value.time || 0

          // Extraction sequence: Acid first, then Sweet, then Bitter
          // Under-extracted (EY < 18): High acid, low sweet, low bitter
          // Perfect (EY 18-22): Balanced
          // Over-extracted (EY > 22): Low acid, low sweet, high bitter

          let acid, sweet, bitter, description

          if (eyv < 16) {
            acid = 80; sweet = 20; bitter = 10
            description = 'Very Sour - Under-extracted'
          } else if (eyv < 18) {
            acid = 60; sweet = 40; bitter = 20
            description = 'Sour - Under-extracted'
          } else if (eyv <= 20) {
            acid = 35; sweet = 50; bitter = 30
            description = 'Sweet & Balanced - Perfect!'
          } else if (eyv <= 22) {
            acid = 25; sweet = 45; bitter = 40
            description = 'Balanced - Good extraction'
          } else if (eyv <= 24) {
            acid = 15; sweet = 30; bitter = 60
            description = 'Bitter - Over-extracted'
          } else {
            acid = 10; sweet = 15; bitter = 80
            description = 'Very Bitter - Over-extracted'
          }

          return { acid, sweet, bitter, description }
        })

        // EY is good? (18-22%)
        const eyIsGood = computed(() => {
          const eyv = eyVal.value
          return eyv >= 18 && eyv <= 22
        })

        // TDS is good? (8-12%)
        const tdsIsGood = computed(() => {
          const tds = shot.value.tds
          return tds >= 8 && tds <= 12
        })

        // Tuning step: 1 = Grind (EY), 2 = Yield (TDS)
        const tuningStep = computed(() => {
          if (!eyIsGood.value && !fixedGrind.value) return 1  // ปรับเบอร์บดก่อน
          return 2  // EY ดีแล้ว หรือ Grind locked → ปรับ Yield
        })

        // ═══════════════════════════════════════════════════════════════
        // 🧠 SMART TUNING ALGORITHM (Feedback Loop + Mathematical Model)
        // ═══════════════════════════════════════════════════════════════
        //
        // Core Formulas:
        // 1. EY% = (Yield × TDS%) / Dose
        // 2. Flow Rate = Yield / Time (g/s) - indicator of grind fineness
        // 3. Grind Correction = Kp × Error × Sensitivity
        //    where: Error = Target_EY - Actual_EY
        //           Sensitivity = f(current_grind) - non-linear
        //
        // Scientific Basis:
        // - Finer grind → Higher extraction (but non-linear, has peak)
        // - Flow rate indicates grind appropriateness
        // - Proportional control with adaptive gain
        // ═══════════════════════════════════════════════════════════════

        // Constants for smart algorithm
        const TARGET_EY = 20.0       // Optimal EY% (center of 18-22%)
        const TARGET_TDS = 10.0      // Optimal TDS% (center of 8-12%)
        const EY_TOLERANCE = 2.0     // ±2% from target = acceptable
        const TDS_TOLERANCE = 2.0    // ±2% from target = acceptable

        // Proportional gain constants (tuned for F64 Evo Pro grinder)
        const Kp_GRIND = 0.08        // Grind adjustment per 1% EY error
        const Kp_YIELD = 1.5         // Yield adjustment per 1% TDS error

        // Calculate grind correction using proportional control
        // Strategy: Aggressive first, then fine-tune (save coffee!)
        const calculateGrindCorrection = (currentGrind, eyError, shotNum) => {
          // Non-linear sensitivity: finer grind = more sensitive
          const sensitivity = 1.5 - (currentGrind - 1) * 0.1  // 1.5 at grind 1, 0.4 at grind 12
          const clampedSensitivity = Math.max(0.3, Math.min(1.5, sensitivity))

          // Proportional correction with sensitivity
          let correction = Kp_GRIND * eyError * clampedSensitivity

          // AGGRESSIVE TUNING: Bigger steps early, smaller steps later
          // Shot 1: max 1.0 step (get close fast!)
          // Shot 2-3: max 0.5 step (approaching target)
          // Shot 4+: max 0.3 step (fine-tuning)
          const absError = Math.abs(eyError)
          let maxStep, minStep

          if (shotNum <= 1 || absError > 6) {
            // First shot or very far from target → aggressive
            maxStep = 1.0
            minStep = 0.5
          } else if (shotNum <= 3 || absError > 3) {
            // Getting closer → moderate
            maxStep = 0.5
            minStep = 0.2
          } else {
            // Close to target → fine-tune
            maxStep = 0.3
            minStep = 0.1
          }

          if (Math.abs(correction) > maxStep) correction = Math.sign(correction) * maxStep
          if (Math.abs(correction) < minStep && correction !== 0) correction = Math.sign(correction) * minStep

          return correction
        }

        // Calculate yield correction using proportional control
        const calculateYieldCorrection = (currentYield, tdsError) => {
          // TDS too high → need more yield (dilute)
          // TDS too low → need less yield (concentrate)
          let correction = Kp_YIELD * tdsError

          // Clamp to reasonable step (2g to 6g)
          const maxStep = 6
          const minStep = 2
          if (Math.abs(correction) > maxStep) correction = Math.sign(correction) * maxStep
          if (Math.abs(correction) < minStep && correction !== 0) correction = Math.sign(correction) * minStep

          return Math.round(correction)
        }

        // Flow rate analysis (diagnostic info)
        const flowRate = computed(() => {
          if (!shot.value.yield || !shot.value.time) return null
          return (shot.value.yield / shot.value.time).toFixed(2)
        })

        const action = computed(() => {
          const g = shot.value.grind
          const eyv = eyVal.value
          const tds = shot.value.tds
          const yld = shot.value.yield
          const time = shot.value.time

          // Calculate errors from target
          const eyError = TARGET_EY - eyv      // Positive = under-extracted, need finer
          const tdsError = tds - TARGET_TDS    // Positive = too strong, need more yield

          // Flow rate diagnostic
          const fr = flowRate.value
          const flowDiag = fr ? `Flow: ${fr} g/s` : ''

          // Step 1: ปรับเบอร์บดก่อน (จน EY 18-22%) - ถ้ายังไม่ lock
          if (!fixedGrind.value) {
            if (Math.abs(eyError) > EY_TOLERANCE) {
              // Calculate smart correction - ใช้ค่าจาก validRanges (grind: min=1, max=12)
              const GRIND_MIN = 1.0
              const GRIND_MAX = 12.0
              const correction = calculateGrindCorrection(g, eyError, shotNumber.value)
              const newGrindVal = Math.max(GRIND_MIN, Math.min(GRIND_MAX, g - correction))
              const newGrind = newGrindVal.toFixed(1)

              // ตรวจสอบว่าติดขอบเขตหรือไม่
              const atMinBoundary = newGrindVal <= GRIND_MIN && eyError > 0
              const atMaxBoundary = newGrindVal >= GRIND_MAX && eyError < 0
              const noChange = parseFloat(newGrind) === parseFloat(g)

              const direction = eyError > 0 ? 'ละเอียดขึ้น' : 'หยาบขึ้น'
              const reason = eyError > 0
                ? `EY ${eyv}% ต่ำไป (เป้า ${TARGET_EY}±${EY_TOLERANCE}%)`
                : `EY ${eyv}% สูงไป (เป้า ${TARGET_EY}±${EY_TOLERANCE}%)`

              // ถ้าติดขอบเขตหรือค่าไม่เปลี่ยน แนะนำทางอื่น
              if (atMinBoundary || (noChange && eyError > 0)) {
                return {
                  step: 1,
                  do: `Grind at minimum (${GRIND_MIN})`,
                  reason: reason,
                  hint: `ลองเพิ่ม Dose หรือลด Yield แทน`,
                  lockGrind: false,
                  correction: 0,
                  newValue: g
                }
              }
              if (atMaxBoundary || (noChange && eyError < 0)) {
                return {
                  step: 1,
                  do: `Grind at maximum (${GRIND_MAX})`,
                  reason: reason,
                  hint: `ลองลด Dose หรือเพิ่ม Yield แทน`,
                  lockGrind: false,
                  correction: 0,
                  newValue: g
                }
              }

              return {
                step: 1,
                do: `เบอร์บด ${g} → ${newGrind}`,
                reason: reason,
                hint: `บด${direction} · Purge 2-3g first`,
                lockGrind: false,
                correction: correction,
                newValue: parseFloat(newGrind)
              }
            }
            // EY ดีแล้ว → Lock Grind!
            if (eyIsGood.value && !tdsIsGood.value) {
              return {
                step: 1,
                do: `Lock Grind ${g}`,
                reason: `EY ${eyv}% ดีแล้ว! (ใน ${TARGET_EY}±${EY_TOLERANCE}%)`,
                hint: 'กด "Shot ถัดไป" เพื่อไปปรับ Yield',
                lockGrind: true,
                correction: 0,
                newValue: g
              }
            }
          }

          // Step 2: Grind locked แล้ว → ปรับ TDS ผ่าน Yield
          if (Math.abs(tdsError) > TDS_TOLERANCE) {
            const correction = calculateYieldCorrection(yld, tdsError)
            // ใช้ค่าจาก validRanges (yield: min=15, max=80)
            const YIELD_MIN = 15
            const YIELD_MAX = 80
            const newYield = Math.max(YIELD_MIN, Math.min(YIELD_MAX, yld + correction))

            // ตรวจสอบว่าติดขอบเขตหรือไม่
            const atMinBoundary = newYield <= YIELD_MIN && tdsError < 0
            const atMaxBoundary = newYield >= YIELD_MAX && tdsError > 0
            const noChange = newYield === yld

            const direction = tdsError > 0 ? 'เพิ่ม' : 'ลด'
            const reason = tdsError > 0
              ? `TDS ${tds}% เข้มไป (เป้า ${TARGET_TDS}±${TDS_TOLERANCE}%)`
              : `TDS ${tds}% จืดไป (เป้า ${TARGET_TDS}±${TDS_TOLERANCE}%)`

            // ถ้าติดขอบเขตหรือค่าไม่เปลี่ยน แนะนำทางอื่น
            if (atMinBoundary || (noChange && tdsError < 0)) {
              return {
                step: 2,
                do: `Yield at minimum (${YIELD_MIN}g)`,
                reason: reason,
                hint: `ลองเพิ่ม Dose หรือบดละเอียดขึ้นแทน`,
                lockGrind: false,
                correction: 0,
                newValue: yld
              }
            }
            if (atMaxBoundary || (noChange && tdsError > 0)) {
              return {
                step: 2,
                do: `Yield at maximum (${YIELD_MAX}g)`,
                reason: reason,
                hint: `ลองลด Dose หรือบดหยาบขึ้นแทน`,
                lockGrind: false,
                correction: 0,
                newValue: yld
              }
            }

            return {
              step: 2,
              do: `Yield ${yld}g → ${newYield}g`,
              reason: reason,
              hint: `${direction} yield ${Math.abs(correction)}g ${flowDiag}`,
              lockGrind: false,
              correction: correction,
              newValue: newYield
            }
          }

          // Perfect! No adjustment needed
          return {
            step: 0,
            do: 'สมบูรณ์แบบ!',
            reason: `EY ${eyv}% และ TDS ${tds}% อยู่ในโซนที่ดี`,
            hint: flowDiag,
            lockGrind: false,
            correction: 0,
            newValue: null
          }
        })

        const reversedHistory = computed(() => [...history.value].reverse())

        function toggleFlavor(id) {
          const idx = shot.value.flavors.indexOf(id)
          if (idx >= 0) {
            shot.value.flavors.splice(idx, 1)
          } else {
            shot.value.flavors.push(id)
          }
        }

        function analyze() {
          if (isAnalyzing.value) return
          isAnalyzing.value = true
          haptic('medium')
          // Brief delay for loading feedback (150ms feels snappy)
          setTimeout(() => {
            isAnalyzing.value = false
            page.value = 'result'
          }, 150)
        }

        function nextShot() {
          // Haptic feedback - success for perfect, medium for continue
          haptic(isPerfect.value ? 'success' : 'medium')

          // Create shot record
          const shotRecord = {
            id: Date.now().toString(),
            bean: beanName.value || '',
            grind: shot.value.grind, dose: shot.value.dose,
            yield: shot.value.yield, time: shot.value.time,
            tds: shot.value.tds, brix: shot.value.brix,
            notes: shot.value.notes || '', rating: shot.value.rating || 0,
            flavors: [...shot.value.flavors],
            ratio: ratio.value, ey: ey.value, isPerfect: isPerfect.value
          }

          // Save to session history
          history.value.push(shotRecord)
          localStorage.setItem('wanwan_history', JSON.stringify(history.value))

          // Save to all-time history (for stats - never cleared)
          allTimeHistory.value.push(shotRecord)
          localStorage.setItem('wanwan_alltime', JSON.stringify(allTimeHistory.value))

          // CONFIRMATION MODE: Need 2 perfect shots to confirm recipe
          if (confirmationMode.value) {
            if (isPerfect.value) {
              confirmationCount.value++
              if (confirmationCount.value >= 2) {
                // Recipe confirmed! Save and reset
                alert('🎉 สูตรยืนยันแล้ว! สกัดได้ Perfect 2 ครั้งติด')
                confirmationMode.value = false
                confirmationCount.value = 0
                confirmedRecipe.value = null
                // Reset session
                history.value = []
                localStorage.removeItem('wanwan_history')
                localStorage.removeItem('wanwan_session')
                shotNumber.value = 1
                fixedDose.value = false
                fixedGrind.value = false
                targetYield.value = null
                beanName.value = ''
                shot.value = {
                  grind: null, dose: null, yield: null,
                  time: null, tds: null, brix: null, notes: '', rating: 0, flavors: []
                }
                showHistory.value = false
                page.value = 'input'
                return
              }
            } else {
              // Failed confirmation - back to tuning
              confirmationMode.value = false
              confirmationCount.value = 0
              confirmedRecipe.value = null
            }
          }

          // If perfect (first time), enter confirmation mode
          if (isPerfect.value && !confirmationMode.value) {
            confirmationMode.value = true
            confirmationCount.value = 0
            confirmedRecipe.value = {
              grind: shot.value.grind,
              dose: shot.value.dose,
              yield: shot.value.yield
            }
            // Set up for confirmation shot (Lock Grind + Dose + Yield, only input Time/TDS/Brix)
            shotNumber.value++
            shot.value = {
              grind: confirmedRecipe.value.grind,
              dose: confirmedRecipe.value.dose,
              yield: confirmedRecipe.value.yield,  // Also locked!
              time: null, tds: null, brix: null,   // Only these need input
              notes: '', rating: 0, flavors: []
            }
            page.value = 'input'
            return
          }

          // Continue tuning
          const lastGrind = shot.value.grind
          const lastDose = shot.value.dose
          const lastYield = shot.value.yield
          const lastTds = shot.value.tds
          const currentEy = eyVal.value

          // After first shot, lock dose and set target yield
          if (shotNumber.value === 1) {
            fixedDose.value = true
            targetYield.value = lastYield
          }

          // Lock grind when EY is good
          if (action.value.lockGrind) {
            fixedGrind.value = true
          }

          // ═══════════════════════════════════════════════════════════════
          // 🧠 SMART TUNING: Use calculated values from action computed
          // ═══════════════════════════════════════════════════════════════
          let nextGrind = lastGrind
          let nextYield = targetYield.value || lastYield

          // Use smart algorithm values from action
          if (action.value.step === 1 && action.value.newValue !== null) {
            // Step 1: Grind adjustment (from smart algorithm)
            nextGrind = action.value.newValue
          } else if (action.value.step === 2 && action.value.newValue !== null) {
            // Step 2: Yield adjustment (from smart algorithm)
            nextYield = action.value.newValue
            targetYield.value = nextYield
          }

          shot.value = {
            grind: parseFloat(nextGrind.toFixed ? nextGrind.toFixed(1) : nextGrind),
            dose: lastDose,
            yield: nextYield,  // Locked - use smart-calculated yield
            time: null, tds: null, brix: null, notes: '', rating: 0, flavors: []
          }

          shotNumber.value++
          showHistory.value = false
          page.value = 'input'

          // Save session state for page refresh
          saveSessionState()
        }

        function copyRecipe() {
          const recipe = `${beanName.value || 'Coffee Recipe'}

Grind: ${shot.value.grind}
Dose: ${shot.value.dose}g
Yield: ${shot.value.yield}g
Time: ${shot.value.time}s
EY: ${ey.value}% | TDS: ${shot.value.tds}%

---
Made with WANWAN COFFEE TUNER`

          navigator.clipboard.writeText(recipe.trim()).then(() => {
            haptic('success')
            copied.value = true
            setTimeout(() => { copied.value = false }, 2000)
          })
        }

        // Web Share API
        const canShare = computed(() => navigator.share !== undefined)

        async function shareRecipe() {
          const recipe = `${beanName.value || 'Coffee Recipe'}

Grind: ${shot.value.grind}
Dose: ${shot.value.dose}g
Yield: ${shot.value.yield}g
Time: ${shot.value.time}s
EY: ${ey.value}% | TDS: ${shot.value.tds}%

Made with WANWAN COFFEE TUNER
https://vongsagon-git.github.io/coffee-tune/`

          try {
            await navigator.share({
              title: `${beanName.value || 'Perfect Espresso Recipe'}`,
              text: recipe.trim(),
              url: 'https://vongsagon-git.github.io/coffee-tune/'
            })
          } catch (err) {
            // User cancelled or share not supported - silent fail
          }
        }

        function saveRecipe() {
          const newRecipe = {
            id: Date.now().toString(),
            bean: beanName.value || 'No Name',
            grind: shot.value.grind,
            dose: shot.value.dose,
            yield: shot.value.yield,
            time: shot.value.time,
            tds: shot.value.tds,
            brix: shot.value.brix,
            ey: ey.value,
            rating: shot.value.rating,
            notes: shot.value.notes,
            flavors: [...shot.value.flavors],
            savedAt: new Date().toISOString()
          }
          recipes.value.push(newRecipe)
          localStorage.setItem('wanwan_recipes', JSON.stringify(recipes.value))
          haptic('success')
          recipeSaved.value = true
          setTimeout(() => { recipeSaved.value = false }, 2000)
        }

        function loadRecipe(r) {
          haptic('medium')
          beanName.value = r.bean || ''
          shot.value.grind = r.grind
          shot.value.dose = r.dose
          targetYield.value = r.yield
          fixedDose.value = true
          fixedGrind.value = true
          page.value = 'input'
        }

        function deleteRecipe(index) {
          if (confirm('Delete this recipe?')) {
            recipes.value.splice(index, 1)
            localStorage.setItem('wanwan_recipes', JSON.stringify(recipes.value))
          }
        }

        function exportData() {
          const data = {
            version: '6.7',
            exportedAt: new Date().toISOString(),
            recipes: recipes.value,
            history: history.value
          }
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
          const url = URL.createObjectURL(blob)
          const a = document.createElement('a')
          a.href = url
          a.download = `wanwan-coffee-${new Date().toISOString().slice(0,10)}.json`
          a.click()
          URL.revokeObjectURL(url)
        }

        function importData() {
          const input = document.createElement('input')
          input.type = 'file'
          input.accept = '.json'
          input.onchange = (e) => {
            const file = e.target.files[0]
            if (!file) return
            const reader = new FileReader()
            reader.onload = (ev) => {
              try {
                const data = JSON.parse(ev.target.result)
                if (data.recipes) {
                  recipes.value = data.recipes
                  localStorage.setItem('wanwan_recipes', JSON.stringify(recipes.value))
                }
                if (data.history) {
                  history.value = data.history
                  localStorage.setItem('wanwan_history', JSON.stringify(history.value))
                }
                alert('✅ Import สำเร็จ!')
              } catch (err) {
                alert('❌ ไฟล์ไม่ถูกต้อง')
              }
            }
            reader.readAsText(file)
          }
          input.click()
        }

        function clearAllData() {
          if (confirm('Clear all data?\n\nWARNING: All recipes and history will be deleted')) {
            localStorage.clear()
            recipes.value = []
            history.value = []
            shotNumber.value = 1
            fixedDose.value = false
            fixedGrind.value = false
            targetYield.value = null
            beanName.value = ''
            shot.value = {
              grind: null, dose: null, yield: null,
              time: null, tds: null, brix: null, notes: '', rating: 0, flavors: []
            }
            page.value = 'input'
            alert('✅ ล้างข้อมูลเรียบร้อย')
          }
        }

        function resetSession() {
          if (confirm('Start new tuning session?\n\nWARNING: Shot history will be cleared')) {
            history.value = []
            localStorage.removeItem('wanwan_history')
            localStorage.removeItem('wanwan_session')
            shotNumber.value = 1
            fixedDose.value = false
            fixedGrind.value = false
            targetYield.value = null
            beanName.value = ''
            shot.value = {
              grind: null, dose: null, yield: null,
              time: null, tds: null, brix: null, notes: '', rating: 0, flavors: []
            }
            showHistory.value = false
            page.value = 'input'
          }
        }

        // Onboarding functions
        function finishOnboarding() {
          showOnboarding.value = false
          localStorage.setItem('wanwan_onboarded', 'true')
          // Auto-focus first input after closing onboarding
          setTimeout(() => {
            const firstInput = document.getElementById('input-grind')
            if (firstInput) firstInput.focus()
          }, 100)
        }

        function skipOnboarding() {
          showOnboarding.value = false
          localStorage.setItem('wanwan_onboarded', 'true')
          // Auto-focus first input after skipping onboarding
          setTimeout(() => {
            const firstInput = document.getElementById('input-grind')
            if (firstInput) firstInput.focus()
          }, 100)
        }

        function showTutorial() {
          onboardingStep.value = 1
          showOnboarding.value = true
        }

        function resetOnboarding() {
          localStorage.removeItem('wanwan_onboarded')
          onboardingStep.value = 1
          showOnboarding.value = true
        }

        // Computed: can install PWA (show button in settings even after dismissing prompt)
        const canInstallPWA = computed(() => {
          return deferredPrompt.value !== null
        })

        // Dark Mode functions
        function toggleDarkMode() {
          haptic('light')
          darkMode.value = !darkMode.value
          localStorage.setItem('wanwan_darkmode', darkMode.value ? 'true' : 'false')
          applyDarkMode()
        }

        function applyDarkMode() {
          if (darkMode.value) {
            document.documentElement.classList.add('dark')
            document.body.classList.remove('bg-sbux-cream', 'text-sbux-brown')
            document.body.classList.add('bg-dark-900', 'text-dark-100')
          } else {
            document.documentElement.classList.remove('dark')
            document.body.classList.remove('bg-dark-900', 'text-dark-100')
            document.body.classList.add('bg-sbux-cream', 'text-sbux-brown')
          }
        }

        // Haptic feedback function (mobile vibrate API)
        function haptic(type = 'light') {
          if (!navigator.vibrate) return
          const patterns = {
            light: 10,      // Short tap
            medium: 25,     // Button press
            success: [15, 50, 15],  // Double tap for success
            error: [50, 30, 50, 30, 50]  // Triple tap for error
          }
          navigator.vibrate(patterns[type] || patterns.light)
        }

        // Page navigation with haptic
        function navigateTo(targetPage) {
          if (page.value === targetPage) return
          haptic('light')
          page.value = targetPage
        }

        // PWA Install functions
        async function installPWA() {
          if (!deferredPrompt.value) return
          deferredPrompt.value.prompt()
          const { outcome } = await deferredPrompt.value.userChoice
          if (outcome === 'accepted') {
            showInstallPrompt.value = false
          }
          deferredPrompt.value = null
        }

        function dismissInstallPrompt() {
          showInstallPrompt.value = false
          localStorage.setItem('wanwan_install_dismissed', 'true')
        }

        // Save session state (for page refresh)
        function saveSessionState() {
          const state = {
            shotNumber: shotNumber.value,
            fixedDose: fixedDose.value,
            fixedGrind: fixedGrind.value,
            targetYield: targetYield.value,
            beanName: beanName.value,
            lastGrind: shot.value.grind,
            lastDose: shot.value.dose
          }
          localStorage.setItem('wanwan_session', JSON.stringify(state))
        }

        // Focus trap for modals (accessibility)
        function trapFocus(e) {
          if (!showOnboarding.value) return

          const modal = document.querySelector('[role="dialog"]')
          if (!modal) return

          const focusableElements = modal.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
          )
          const firstEl = focusableElements[0]
          const lastEl = focusableElements[focusableElements.length - 1]

          if (e.key === 'Tab') {
            if (e.shiftKey && document.activeElement === firstEl) {
              e.preventDefault()
              lastEl.focus()
            } else if (!e.shiftKey && document.activeElement === lastEl) {
              e.preventDefault()
              firstEl.focus()
            }
          }

          // Close modal on Escape
          if (e.key === 'Escape') {
            e.preventDefault()
            skipOnboarding()
          }
        }

        // Keyboard shortcut handler
        function handleKeyboard(e) {
          // Focus trap for modals
          if (showOnboarding.value) {
            trapFocus(e)
            return
          }

          // Enter key to analyze (when on input page and can analyze)
          if (e.key === 'Enter' && page.value === 'input' && canAnalyze.value) {
            e.preventDefault()
            analyze()
          }
          // Escape key to go back to input from result
          if (e.key === 'Escape' && page.value === 'result') {
            e.preventDefault()
            page.value = 'input'
          }
        }

        onMounted(() => {
          // Add keyboard listener
          window.addEventListener('keydown', handleKeyboard)

          // Online/Offline listeners
          window.addEventListener('online', () => { isOnline.value = true })
          window.addEventListener('offline', () => { isOnline.value = false })

          // PWA Install prompt listener
          window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault()
            deferredPrompt.value = e
            // Show install prompt if not dismissed before
            const dismissed = localStorage.getItem('wanwan_install_dismissed')
            if (!dismissed) {
              showInstallPrompt.value = true
            }
          })

          // Check if first-time user (show onboarding)
          const onboarded = localStorage.getItem('wanwan_onboarded')
          if (!onboarded) {
            showOnboarding.value = true
          }

          // Load dark mode preference
          const savedDarkMode = localStorage.getItem('wanwan_darkmode')
          if (savedDarkMode === 'true') {
            darkMode.value = true
            applyDarkMode()
          }

          // Load session history
          const saved = localStorage.getItem('wanwan_history')
          if (saved) {
            history.value = JSON.parse(saved)
          }

          // Load all-time history (for stats)
          const allTime = localStorage.getItem('wanwan_alltime')
          if (allTime) {
            allTimeHistory.value = JSON.parse(allTime)
          }

          // Load recipes
          const savedRecipes = localStorage.getItem('wanwan_recipes')
          if (savedRecipes) {
            recipes.value = JSON.parse(savedRecipes)
          }

          // Restore state from history (more reliable than session state)
          if (history.value.length > 0) {
            const lastShot = history.value[history.value.length - 1]
            shotNumber.value = history.value.length + 1

            // Restore from last shot in history
            beanName.value = lastShot.bean || ''
            fixedDose.value = true  // Dose is always fixed after shot 1
            targetYield.value = lastShot.yield

            // Check if grind was locked (EY was good)
            fixedGrind.value = lastShot.ey >= 18 && lastShot.ey <= 22

            // Pre-fill next shot values
            shot.value.dose = lastShot.dose
            shot.value.yield = lastShot.yield

            // Calculate next grind from action (if EY not good yet)
            if (!fixedGrind.value) {
              const eyError = 20 - lastShot.ey
              const correction = 0.08 * eyError * (1.5 - (lastShot.grind - 1) * 0.1)
              const clampedCorrection = Math.max(-1, Math.min(1, correction))
              shot.value.grind = parseFloat(Math.max(1, Math.min(12, lastShot.grind - clampedCorrection)).toFixed(1))
            } else {
              shot.value.grind = lastShot.grind
            }
          } else {
            shotNumber.value = 1
          }

          // Auto-focus first input after onboarding is done (with slight delay for animation)
          setTimeout(() => {
            if (!showOnboarding.value) {
              const firstInput = document.getElementById('input-grind')
              if (firstInput) firstInput.focus()
            }
          }, 300)
        })

        return {
          page, shotNumber, showHistory, fixedDose, fixedGrind, targetYield, shot, history,
          canAnalyze, ratio, ey, isPerfect, direction, tuningStep, eyIsGood, tdsIsGood,
          chartX, chartY, expectedFlavors, action, reversedHistory, flavorProfile, stats,
          validationErrors, validRanges, copied, recipeSaved, recipes, allTimeHistory,
          confirmationMode, confirmationCount, confirmedRecipe,
          analyze, nextShot, resetSession, toggleFlavor, flavorOptions, beanName,
          copyRecipe, saveRecipe, loadRecipe, deleteRecipe, canShare, shareRecipe,
          exportData, importData, clearAllData,
          showOnboarding, onboardingStep, finishOnboarding, skipOnboarding, showTutorial, resetOnboarding,
          darkMode, toggleDarkMode,
          isOnline, showInstallPrompt, installPWA, dismissInstallPrompt, canInstallPWA, deferredPrompt,
          haptic, navigateTo, isAnalyzing
        }
      }
    }).mount('#app')

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {})
    }
  </script>
</body>
</html>
