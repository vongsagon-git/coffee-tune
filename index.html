<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WANWAN COFFEE | Dial-In</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            coffee: {
              50: '#fdf8f6',
              100: '#f2e8e5',
              200: '#eaddd7',
              300: '#e0cec7',
              400: '#d2bab0',
              500: '#bfa094',
              600: '#a18072',
              700: '#977669',
              800: '#846358',
              900: '#43302b',
            }
          }
        }
      }
    }
  </script>
  <style>
    [v-cloak] { display: none; }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] { -moz-appearance: textfield; }

    @keyframes saveFlash {
      0% { transform: scale(1); }
      50% { transform: scale(0.95); background-color: #22c55e; }
      100% { transform: scale(1); }
    }
    .save-flash {
      animation: saveFlash 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
  </style>
</head>
<body class="bg-coffee-50 min-h-screen">
  <div id="app" v-cloak>
    <!-- Header -->
    <header class="bg-gradient-to-r from-coffee-900 via-coffee-800 to-coffee-900 text-white py-3 px-4 sticky top-0 z-50 shadow-lg">
      <div class="max-w-md mx-auto flex items-center justify-between">
        <div>
          <h1 class="text-lg font-bold flex items-center gap-2">
            üêï WANWAN COFFEE
          </h1>
          <p class="text-coffee-400 text-xs">Dial-In Loop</p>
        </div>
        <div class="text-right text-xs text-coffee-400">
          <p>Appia Life XT 2GR</p>
          <p>F64 Evo Pro GBW</p>
        </div>
      </div>
    </header>

    <main class="max-w-md mx-auto px-4 py-4 space-y-4">
      <!-- Shot Counter -->
      <div class="text-center text-sm text-coffee-500">
        Shot #{{ history.length + 1 }}
      </div>

      <!-- Input Form -->
      <section class="bg-white rounded-2xl shadow-md p-4">
        <div class="grid grid-cols-2 gap-3">
          <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ö‡∏î -->
          <div>
            <label class="block text-xs font-medium text-coffee-600 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ö‡∏î (F64)</label>
            <input
              type="number"
              v-model.number="shot.grind"
              step="0.1"
              min="1.0"
              max="12.0"
              class="w-full h-12 px-3 text-xl font-bold text-center border-2 border-coffee-200 rounded-xl focus:border-coffee-500 focus:outline-none"
              placeholder="3.5"
            >
          </div>

          <!-- Dose -->
          <div>
            <label class="block text-xs font-medium text-coffee-600 mb-1">Dose (g)</label>
            <input
              type="number"
              v-model.number="shot.dose"
              step="0.1"
              class="w-full h-12 px-3 text-xl font-bold text-center border-2 border-coffee-200 rounded-xl focus:border-coffee-500 focus:outline-none"
              placeholder="18"
            >
          </div>

          <!-- Yield -->
          <div>
            <label class="block text-xs font-medium text-coffee-600 mb-1">Yield (g)</label>
            <input
              type="number"
              v-model.number="shot.yield"
              step="0.1"
              class="w-full h-12 px-3 text-xl font-bold text-center border-2 border-coffee-200 rounded-xl focus:border-coffee-500 focus:outline-none"
              placeholder="36"
            >
          </div>

          <!-- Time -->
          <div>
            <label class="block text-xs font-medium text-coffee-600 mb-1">Time (s)</label>
            <input
              type="number"
              v-model.number="shot.time"
              class="w-full h-12 px-3 text-xl font-bold text-center border-2 border-coffee-200 rounded-xl focus:border-coffee-500 focus:outline-none"
              placeholder="27"
            >
          </div>

          <!-- TDS -->
          <div>
            <label class="block text-xs font-medium text-coffee-600 mb-1">TDS (%) <span class="text-coffee-400">*refract</span></label>
            <input
              type="number"
              v-model.number="shot.tds"
              step="0.1"
              class="w-full h-12 px-3 text-xl font-bold text-center border-2 border-coffee-200 rounded-xl focus:border-coffee-500 focus:outline-none"
              placeholder="10"
            >
          </div>

          <!-- Brix -->
          <div>
            <label class="block text-xs font-medium text-coffee-600 mb-1">Brix (%) <span class="text-coffee-400">*refract</span></label>
            <input
              type="number"
              v-model.number="shot.brix"
              step="0.1"
              class="w-full h-12 px-3 text-xl font-bold text-center border-2 border-coffee-200 rounded-xl focus:border-coffee-500 focus:outline-none"
              placeholder="12"
            >
          </div>
        </div>

        <!-- Computed -->
        <div class="mt-3 pt-3 border-t border-coffee-100 flex justify-between text-sm">
          <span class="text-coffee-500">
            Ratio:
            <strong v-if="shot.dose && shot.yield" class="text-coffee-800">1:{{ ratio }}</strong>
            <span v-else class="text-coffee-400">-</span>
          </span>
          <span class="text-coffee-500">
            EY:
            <strong v-if="shot.tds && shot.dose && shot.yield" :class="eyClass">{{ ey }}%</strong>
            <span v-else class="text-coffee-400">-</span>
          </span>
        </div>
      </section>

      <!-- Result -->
      <section v-if="hasInput" class="bg-white rounded-2xl shadow-md p-4">
        <!-- Perfect Zone -->
        <div v-if="isPerfect" class="text-center">
          <div class="text-4xl mb-2">üéØ</div>
          <h2 class="text-xl font-bold text-green-600 mb-3">PERFECT!</h2>
          <div class="bg-green-50 rounded-xl p-3 text-sm text-green-700">
            <p>‚úÖ EY {{ ey }}% (‡πÄ‡∏õ‡πâ‡∏≤ 18-22%)</p>
            <p v-if="shot.tds">‚úÖ TDS {{ shot.tds }}% (‡πÄ‡∏õ‡πâ‡∏≤ 8-12%)</p>
            <p class="mt-2 font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Recipe ‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ!</p>
          </div>
        </div>

        <!-- Need Adjustment -->
        <div v-else>
          <div class="text-center mb-3">
            <span class="text-3xl">{{ action.icon }}</span>
            <h2 class="text-lg font-bold text-coffee-800 mt-1">{{ action.title }}</h2>
          </div>

          <div class="bg-amber-50 rounded-xl p-4 text-center">
            <p class="text-2xl font-bold text-amber-800">{{ action.do }}</p>
            <p class="text-sm text-amber-600 mt-1">{{ action.reason }}</p>
          </div>

          <div class="mt-3 text-xs text-coffee-500 text-center">
            <p v-if="eyStatus">EY: {{ ey }}% ‚Üí {{ eyStatus }}</p>
            <p v-if="tdsStatus">TDS: {{ shot.tds }}% ‚Üí {{ tdsStatus }}</p>
            <p v-if="timeStatus">Time: {{ shot.time }}s ‚Üí {{ timeStatus }}</p>
          </div>
        </div>
      </section>

      <!-- Action Buttons -->
      <div class="flex gap-3">
        <button
          ref="saveBtn"
          @click="saveAndNext"
          :disabled="!canSave"
          class="flex-1 h-14 rounded-xl font-bold text-lg transition-all"
          :class="[
            canSave
              ? 'bg-coffee-700 text-white hover:bg-coffee-800 active:scale-95'
              : 'bg-coffee-200 text-coffee-400',
            saveFlash ? 'save-flash' : ''
          ]"
        >
          {{ isPerfect ? 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Recipe' : 'üîÑ ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Üí Shot ‡∏ï‡πà‡∏≠‡πÑ‡∏õ' }}
        </button>
      </div>

      <!-- History -->
      <section v-if="history.length > 0" class="bg-white rounded-2xl shadow-md p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold text-coffee-800">üìú History ({{ history.length }})</h3>
          <button @click="clearHistory" class="text-xs text-red-400 hover:text-red-600">‡∏•‡πâ‡∏≤‡∏á</button>
        </div>

        <div class="space-y-2 max-h-48 overflow-y-auto">
          <div
            v-for="(h, i) in reversedHistory"
            :key="h.id"
            class="flex items-center gap-2 p-2 bg-coffee-50 rounded-lg text-sm"
          >
            <span class="text-lg">{{ h.isPerfect ? 'üéØ' : 'üîÑ' }}</span>
            <div class="flex-1">
              <div class="font-medium text-coffee-800">
                #{{ history.length - i }} | {{ h.grind }} | {{ h.dose }}g‚Üí{{ h.yield }}g | {{ h.time }}s
              </div>
              <div class="text-xs text-coffee-500">
                Ratio 1:{{ h.ratio }} | EY {{ h.ey || '-' }}% | TDS {{ h.tds || '-' }}%
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="text-center py-4 text-xs text-coffee-400">
      üêï WANWAN COFFEE Dial-In v3.0
    </footer>
  </div>

  <script>
    const { createApp, ref, computed, watch, onMounted } = Vue

    createApp({
      setup() {
        // State
        const shot = ref({
          grind: null,
          dose: null,
          yield: null,
          time: null,
          tds: null,
          brix: null
        })

        const history = ref([])
        const saveFlash = ref(false)

        // Computed
        const ratio = computed(() => {
          if (!shot.value.dose || !shot.value.yield) return '0.0'
          return (shot.value.yield / shot.value.dose).toFixed(1)
        })

        const ey = computed(() => {
          if (!shot.value.dose || !shot.value.yield || !shot.value.tds) return '0.0'
          return ((shot.value.yield * shot.value.tds) / shot.value.dose).toFixed(1)
        })

        const hasInput = computed(() => {
          return shot.value.grind && shot.value.dose && shot.value.yield && shot.value.time
        })

        const canSave = computed(() => hasInput.value)

        const eyVal = computed(() => parseFloat(ey.value))
        const tdsVal = computed(() => shot.value.tds || 0)

        const isPerfect = computed(() => {
          if (!shot.value.tds) return false
          return eyVal.value >= 18 && eyVal.value <= 22 && tdsVal.value >= 8 && tdsVal.value <= 12
        })

        const eyClass = computed(() => {
          if (eyVal.value >= 18 && eyVal.value <= 22) return 'text-green-600'
          return 'text-amber-600'
        })

        const eyStatus = computed(() => {
          if (!shot.value.tds) return null
          if (eyVal.value < 18) return '‡∏ï‡πà‡∏≥ (Under-extracted)'
          if (eyVal.value > 22) return '‡∏™‡∏π‡∏á (Over-extracted)'
          return '‡∏û‡∏≠‡∏î‡∏µ ‚úÖ'
        })

        const tdsStatus = computed(() => {
          if (!shot.value.tds) return null
          if (tdsVal.value < 8) return '‡∏à‡∏∑‡∏î (Weak)'
          if (tdsVal.value > 12) return '‡πÄ‡∏Ç‡πâ‡∏°‡πÄ‡∏Å‡∏¥‡∏ô (Strong)'
          return '‡∏û‡∏≠‡∏î‡∏µ ‚úÖ'
        })

        const timeStatus = computed(() => {
          const t = shot.value.time
          if (!t) return null
          if (t < 20) return '‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ'
          if (t > 35) return '‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ'
          return '‡∏û‡∏≠‡∏î‡∏µ'
        })

        const action = computed(() => {
          const g = shot.value.grind
          const t = shot.value.time
          const tds = tdsVal.value
          const eyv = eyVal.value

          // Priority 1: EY via Grind
          if (shot.value.tds) {
            if (eyv < 18) {
              const newGrind = Math.max(1.0, g - 0.3).toFixed(1)
              return {
                icon: '‚¨áÔ∏è',
                title: '‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô',
                do: `${g} ‚Üí ${newGrind}`,
                reason: `EY ${eyv}% ‡∏ï‡πà‡∏≥ ‚Üí ‡∏™‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠`
              }
            }
            if (eyv > 22) {
              const newGrind = Math.min(12.0, parseFloat(g) + 0.3).toFixed(1)
              return {
                icon: '‚¨ÜÔ∏è',
                title: '‡∏ö‡∏î‡∏´‡∏¢‡∏≤‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô',
                do: `${g} ‚Üí ${newGrind}`,
                reason: `EY ${eyv}% ‡∏™‡∏π‡∏á ‚Üí ‡∏™‡∏Å‡∏±‡∏î‡πÄ‡∏Å‡∏¥‡∏ô`
              }
            }

            // EY OK, check TDS
            if (tds > 12) {
              const newYield = Math.round(shot.value.yield + 4)
              return {
                icon: 'üìà',
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏° Yield',
                do: `${shot.value.yield}g ‚Üí ${newYield}g`,
                reason: `TDS ${tds}% ‡πÄ‡∏Ç‡πâ‡∏°‡πÄ‡∏Å‡∏¥‡∏ô`
              }
            }
            if (tds < 8) {
              const newYield = Math.max(shot.value.dose * 1.5, shot.value.yield - 4)
              return {
                icon: 'üìâ',
                title: '‡∏•‡∏î Yield',
                do: `${shot.value.yield}g ‚Üí ${Math.round(newYield)}g`,
                reason: `TDS ${tds}% ‡∏à‡∏∑‡∏î`
              }
            }
          }

          // No TDS - use Time
          if (t < 20) {
            const newGrind = Math.max(1.0, g - 0.3).toFixed(1)
            return {
              icon: '‚¨áÔ∏è',
              title: '‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô',
              do: `${g} ‚Üí ${newGrind}`,
              reason: `Time ${t}s ‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ`
            }
          }
          if (t > 35) {
            const newGrind = Math.min(12.0, parseFloat(g) + 0.3).toFixed(1)
            return {
              icon: '‚¨ÜÔ∏è',
              title: '‡∏ö‡∏î‡∏´‡∏¢‡∏≤‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô',
              do: `${g} ‚Üí ${newGrind}`,
              reason: `Time ${t}s ‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ`
            }
          }

          // Time OK, no TDS
          return {
            icon: '‚úÖ',
            title: 'Time ‡∏û‡∏≠‡∏î‡∏µ',
            do: '‡∏ä‡∏¥‡∏°‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥',
            reason: '‡πÉ‡∏™‡πà TDS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì EY'
          }
        })

        const reversedHistory = computed(() => [...history.value].reverse())

        // Methods
        function saveAndNext() {
          const record = {
            id: Date.now().toString(),
            grind: shot.value.grind,
            dose: shot.value.dose,
            yield: shot.value.yield,
            time: shot.value.time,
            tds: shot.value.tds,
            brix: shot.value.brix,
            ratio: ratio.value,
            ey: shot.value.tds ? ey.value : null,
            isPerfect: isPerfect.value
          }

          history.value.push(record)
          localStorage.setItem('wanwan_history', JSON.stringify(history.value))

          // Flash animation
          saveFlash.value = true
          setTimeout(() => { saveFlash.value = false }, 300)

          // Keep grind for next shot
          const lastGrind = shot.value.grind
          const lastDose = shot.value.dose

          // Reset for next shot
          shot.value = {
            grind: lastGrind,
            dose: lastDose,
            yield: null,
            time: null,
            tds: null,
            brix: null
          }
        }

        function clearHistory() {
          if (confirm('‡∏•‡πâ‡∏≤‡∏á history ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
            history.value = []
            localStorage.removeItem('wanwan_history')
          }
        }

        // Load
        onMounted(() => {
          const saved = localStorage.getItem('wanwan_history')
          if (saved) {
            history.value = JSON.parse(saved)
          }
        })

        return {
          shot,
          history,
          saveFlash,
          ratio,
          ey,
          hasInput,
          canSave,
          isPerfect,
          eyClass,
          eyStatus,
          tdsStatus,
          timeStatus,
          action,
          reversedHistory,
          saveAndNext,
          clearHistory
        }
      }
    }).mount('#app')
  </script>
</body>
</html>
